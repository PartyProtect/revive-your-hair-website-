<!-- Function Usage Monitoring Widget -->
<div class="dashboard-card">
  <div class="card-header">
    <h3>‚ö° Netlify Function Usage</h3>
    <span class="refresh-badge" id="function-usage-refresh">Live</span>
  </div>
  
  <div class="usage-grid">
    <!-- Reddit Proxy Usage -->
    <div class="usage-item">
      <div class="usage-label">
        <span class="icon">üîÑ</span>
        Reddit Proxy Calls
      </div>
      <div class="usage-value" id="reddit-proxy-count">
        <span class="count">-</span>
        <span class="unit">calls</span>
      </div>
      <div class="usage-info">
        <span id="reddit-proxy-rate">- calls/day</span>
        <span class="separator">‚Ä¢</span>
        <span id="reddit-proxy-cost">$0.00 est.</span>
      </div>
    </div>
    
    <!-- Analytics Tracking Usage -->
    <div class="usage-item">
      <div class="usage-label">
        <span class="icon">üìä</span>
        Analytics Tracking
      </div>
      <div class="usage-value">
        <span class="count">N/A</span>
        <span class="unit">auto</span>
      </div>
      <div class="usage-info">
        <span>Always active</span>
      </div>
    </div>
    
    <!-- Free Tier Limit -->
    <div class="usage-item limit-item">
      <div class="usage-label">
        <span class="icon">üéØ</span>
        Free Tier Limit
      </div>
      <div class="usage-value">
        <span class="count">125,000</span>
        <span class="unit">calls/month</span>
      </div>
      <div class="usage-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="usage-progress-bar" style="width: 0%"></div>
        </div>
        <span class="progress-text" id="usage-percentage">0%</span>
      </div>
    </div>
  </div>
  
  <!-- Warnings -->
  <div class="usage-warnings" id="usage-warnings" style="display: none;">
    <div class="warning-banner">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <div class="warning-content">
        <strong>High Usage Detected</strong>
        <p id="warning-message"></p>
      </div>
    </div>
  </div>
  
  <!-- Recommendations -->
  <div class="usage-recommendations">
    <h4>üí° Optimization Tips</h4>
    <ul id="recommendations-list">
      <li>‚úÖ Using static JSON for Reddit feed (good!)</li>
      <li>Monitor this dashboard for unexpected spikes</li>
      <li>Reddit proxy should have <strong>very low usage</strong></li>
    </ul>
  </div>
  
  <div class="card-footer">
    <small>Last reset: <span id="usage-reset-date">-</span></small>
    <button class="btn-secondary" id="reset-usage-btn">Reset Counter</button>
  </div>
</div>

<style>
.usage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.usage-item {
  background: var(--gray-50, #f9fafb);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid var(--gray-200, #e5e7eb);
  transition: all 0.2s;
}

.usage-item:hover {
  border-color: var(--forest-green, #2d5016);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.usage-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
  color: var(--gray-medium, #6b7280);
  margin-bottom: 12px;
}

.usage-label .icon {
  font-size: 1.2em;
}

.usage-value {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 8px;
}

.usage-value .count {
  font-size: 2em;
  font-weight: 700;
  color: var(--charcoal, #1f2937);
}

.usage-value .unit {
  font-size: 0.9em;
  color: var(--gray-medium, #6b7280);
}

.usage-info {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85em;
  color: var(--gray-medium, #6b7280);
}

.usage-info .separator {
  opacity: 0.5;
}

.limit-item {
  background: var(--green-tint, #f0fdf4);
  border-color: var(--forest-green-light, #86efac);
}

.usage-progress {
  margin-top: 12px;
}

.progress-bar {
  height: 8px;
  background: var(--gray-200, #e5e7eb);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 4px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #2d5016 0%, #86efac 100%);
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 0.85em;
  color: var(--gray-medium, #6b7280);
}

.usage-warnings {
  margin: 20px 0;
}

.warning-banner {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: #fffbeb;
  border: 2px solid #fbbf24;
  border-radius: 8px;
}

.warning-icon {
  font-size: 1.5em;
}

.warning-content {
  flex: 1;
}

.warning-content strong {
  display: block;
  margin-bottom: 4px;
  color: var(--charcoal, #1f2937);
}

.warning-content p {
  margin: 0;
  color: var(--gray-dark, #374151);
  font-size: 0.9em;
}

.usage-recommendations {
  margin-top: 20px;
  padding: 16px;
  background: white;
  border-radius: 8px;
  border: 1px solid var(--gray-200, #e5e7eb);
}

.usage-recommendations h4 {
  margin: 0 0 12px 0;
  font-size: 0.95em;
  color: var(--charcoal, #1f2937);
}

.usage-recommendations ul {
  margin: 0;
  padding-left: 20px;
  list-style: none;
}

.usage-recommendations li {
  margin-bottom: 8px;
  font-size: 0.9em;
  color: var(--gray-dark, #374151);
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--gray-200, #e5e7eb);
}

.btn-secondary {
  padding: 8px 16px;
  background: var(--gray-100, #f3f4f6);
  border: 1px solid var(--gray-200, #e5e7eb);
  border-radius: 6px;
  font-size: 0.85em;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  background: var(--gray-200, #e5e7eb);
}
</style>

<script>
(async function() {
  const FREE_TIER_LIMIT = 125000; // Netlify free tier
  const COST_PER_MILLION = 25; // $25 per million invocations
  
  // Load usage data
  async function loadUsageData() {
    try {
      const apiKey = localStorage.getItem('admin_api_key');
      const response = await fetch('/.netlify/functions/tracking?action=stats', {
        headers: {
          'X-API-Key': apiKey
        }
      });
      
      if (!response.ok) throw new Error('Failed to fetch stats');
      
      const data = await response.json();
      return data.functionUsage || { redditProxy: 0, lastReset: new Date().toISOString() };
    } catch (error) {
      console.error('[Function Usage] Error loading data:', error);
      return { redditProxy: 0, lastReset: new Date().toISOString() };
    }
  }
  
  // Update UI
  function updateUI(usage) {
    const redditCount = usage.redditProxy || 0;
    const lastReset = new Date(usage.lastReset);
    const daysSinceReset = Math.max(1, Math.floor((Date.now() - lastReset.getTime()) / (1000 * 60 * 60 * 24)));
    const callsPerDay = Math.round(redditCount / daysSinceReset);
    const monthlyEstimate = callsPerDay * 30;
    const estimatedCost = (redditCount / 1000000) * COST_PER_MILLION;
    const percentageUsed = (monthlyEstimate / FREE_TIER_LIMIT) * 100;
    
    // Update counts
    document.getElementById('reddit-proxy-count').querySelector('.count').textContent = 
      redditCount.toLocaleString();
    document.getElementById('reddit-proxy-rate').textContent = 
      `${callsPerDay.toLocaleString()} calls/day`;
    document.getElementById('reddit-proxy-cost').textContent = 
      `$${estimatedCost.toFixed(4)} est.`;
    
    // Update progress
    document.getElementById('usage-progress-bar').style.width = `${Math.min(100, percentageUsed)}%`;
    document.getElementById('usage-percentage').textContent = `${percentageUsed.toFixed(1)}%`;
    
    // Update reset date
    document.getElementById('usage-reset-date').textContent = lastReset.toLocaleDateString();
    
    // Show warnings if needed
    const warningsDiv = document.getElementById('usage-warnings');
    const warningMessage = document.getElementById('warning-message');
    const recommendations = document.getElementById('recommendations-list');
    
    if (monthlyEstimate > FREE_TIER_LIMIT * 0.8) {
      warningsDiv.style.display = 'block';
      warningMessage.innerHTML = `
        Your Reddit proxy is being called <strong>${callsPerDay} times per day</strong>.
        At this rate, you'll hit <strong>${percentageUsed.toFixed(0)}%</strong> of your free tier limit.
        <br><strong>Recommended:</strong> Switch to build-time fetching to reduce costs.
      `;
      
      recommendations.innerHTML = `
        <li>‚ö†Ô∏è High usage detected - optimization recommended</li>
        <li>üí° Switch to build-time Reddit fetching</li>
        <li>üí° Use static JSON file (updates on deploy)</li>
        <li>üí∞ Estimated savings: ~99% of function calls</li>
      `;
    } else if (redditCount > 100) {
      warningsDiv.style.display = 'block';
      warningMessage.innerHTML = `
        Reddit proxy has been called <strong>${redditCount} times</strong> since ${lastReset.toLocaleDateString()}.
        Usage is currently within acceptable limits, but monitor for unexpected spikes.
      `;
    } else {
      warningsDiv.style.display = 'none';
      recommendations.innerHTML = `
        <li>‚úÖ Usage is very low - no action needed</li>
        <li>‚úÖ Static JSON approach is working well</li>
        <li>üí° Continue monitoring for spikes</li>
      `;
    }
    
    // Color progress bar based on usage
    const progressBar = document.getElementById('usage-progress-bar');
    if (percentageUsed < 50) {
      progressBar.style.background = '#10b981';
    } else if (percentageUsed < 80) {
      progressBar.style.background = '#f59e0b';
    } else {
      progressBar.style.background = '#ef4444';
    }
  }
  
  // Reset counter
  document.getElementById('reset-usage-btn').addEventListener('click', async () => {
    if (!confirm('Reset usage counter? This will clear all function usage statistics.')) {
      return;
    }
    
    try {
      // Reset via API (you'd need to add this endpoint)
      alert('Counter reset functionality coming soon!');
      // For now, just reload
      location.reload();
    } catch (error) {
      alert('Failed to reset counter: ' + error.message);
    }
  });
  
  // Initial load
  const usage = await loadUsageData();
  updateUI(usage);
  
  // Refresh every 30 seconds
  setInterval(async () => {
    const usage = await loadUsageData();
    updateUI(usage);
    document.getElementById('function-usage-refresh').textContent = 'Updated';
    setTimeout(() => {
      document.getElementById('function-usage-refresh').textContent = 'Live';
    }, 2000);
  }, 30000);
})();
</script>
