<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Revive Your Hair</title>
  
  <!-- Prevent search engine indexing -->
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Security -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <style>
    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Base */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f3f4f6;
      color: #1f2937;
      line-height: 1.6;
      min-height: 100vh;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #047857 0%, #059669 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(4, 120, 87, 0.2);
    }

    .admin-header h1 {
      font-size: 2em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-header .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
    }

    .admin-header .live-dot {
      width: 10px;
      height: 10px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .stat-card-title {
      font-size: 0.9em;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      font-size: 24px;
      opacity: 0.5;
    }

    .stat-card-value {
      font-size: 2.5em;
      font-weight: 700;
      color: #047857;
      margin-bottom: 8px;
    }

    .stat-card-change {
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-card-change.positive {
      color: #10b981;
    }

    .stat-card-change.negative {
      color: #ef4444;
    }

    /* Charts Section */
    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chart-card h3 {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .chart-placeholder {
      height: 300px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-style: italic;
    }

    /* Activity Feed */
    .activity-feed {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 32px;
    }

    .activity-feed h3 {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .activity-item {
      padding: 16px;
      border-left: 3px solid #e5e7eb;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }

    .activity-item:hover {
      border-left-color: #047857;
      background: #f9fafb;
    }

    .activity-item-time {
      font-size: 0.85em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .activity-item-text {
      color: #1f2937;
    }

    /* Security Section */
    .security-section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 32px;
    }

    .security-section h3 {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .security-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .security-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .security-item-label {
      font-weight: 500;
      color: #374151;
    }

    .security-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .security-badge.active {
      background: #d1fae5;
      color: #047857;
    }

    .security-badge.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .security-badge.inactive {
      background: #fee2e2;
      color: #dc2626;
    }

    /* Quick Actions */
    .quick-actions {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .quick-actions h3 {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .action-button {
      padding: 16px;
      background: linear-gradient(135deg, #047857 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: center;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(4, 120, 87, 0.3);
    }

    .action-button.secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr;
      }

      .admin-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .actions-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Login Protection */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .login-box {
      background: white;
      padding: 48px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    .login-box h2 {
      margin-bottom: 24px;
      color: #047857;
      text-align: center;
    }

    .login-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .login-input:focus {
      outline: none;
      border-color: #047857;
    }

    .login-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #047857 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-button:hover {
      transform: translateY(-2px);
    }

    .login-error {
      color: #dc2626;
      text-align: center;
      margin-top: 12px;
      font-size: 0.9em;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <!-- Login Protection -->
  <div id="login-overlay" class="login-overlay">
    <div class="login-box">
      <h2>üîê Admin Access</h2>
      <p style="text-align: center; color: #6b7280; margin-bottom: 24px;">Enter password to continue</p>
      <input type="password" id="admin-password" class="login-input" placeholder="Enter password" autofocus>
      <button onclick="checkPassword()" class="login-button">Access Dashboard</button>
      <div id="login-error" class="login-error hidden"></div>
    </div>
  </div>

  <!-- Main Dashboard (hidden until login) -->
  <div id="dashboard-content" class="hidden">
    <div class="admin-container">
      
      <!-- Header -->
      <div class="admin-header">
        <h1>
          <span>üìä</span>
          Admin Dashboard
        </h1>
        <div class="live-indicator">
          <div class="live-dot"></div>
          <span>Live Data</span>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Total Visitors</span>
            <span class="stat-card-icon">üë•</span>
          </div>
          <div class="stat-card-value" id="total-visitors">-</div>
          <div class="stat-card-change positive">
            <span>‚Üë</span>
            <span id="visitors-change">Loading...</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Page Views (Today)</span>
            <span class="stat-card-icon">üìÑ</span>
          </div>
          <div class="stat-card-value" id="page-views">-</div>
          <div class="stat-card-change positive">
            <span>‚Üë</span>
            <span id="pageviews-change">Loading...</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Bots Blocked</span>
            <span class="stat-card-icon">ü§ñ</span>
          </div>
          <div class="stat-card-value" id="bots-blocked">-</div>
          <div class="stat-card-change">
            <span id="bots-percentage">-</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Avg. Session</span>
            <span class="stat-card-icon">‚è±Ô∏è</span>
          </div>
          <div class="stat-card-value" id="avg-session">-</div>
          <div class="stat-card-change positive">
            <span>‚Üë</span>
            <span id="session-change">Loading...</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Bounce Rate</span>
            <span class="stat-card-icon">üìä</span>
          </div>
          <div class="stat-card-value" id="bounce-rate">-</div>
          <div class="stat-card-change negative">
            <span>‚Üì</span>
            <span id="bounce-change">Loading...</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Form Submissions</span>
            <span class="stat-card-icon">üì¨</span>
          </div>
          <div class="stat-card-value" id="form-submissions">-</div>
          <div class="stat-card-change">
            <span id="forms-spam">Spam blocked: -</span>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-section">
        <div class="chart-card">
          <h3>üìà Visitor Trends (7 Days)</h3>
          <div class="chart-placeholder" id="visitors-chart">
            Connect Google Analytics to see live charts
          </div>
        </div>

        <div class="chart-card">
          <h3>üåç Top Traffic Sources</h3>
          <div class="chart-placeholder" id="sources-chart">
            Connect Google Analytics to see traffic sources
          </div>
        </div>
      </div>

      <!-- Security Status -->
      <div class="security-section">
        <h3>üîí Security Status</h3>
        <div class="security-status">
          <div class="security-item">
            <span class="security-item-label">Bot Detection</span>
            <span class="security-badge active" id="bot-detection-status">Active</span>
          </div>
          <div class="security-item">
            <span class="security-item-label">HTTPS/HSTS</span>
            <span class="security-badge active" id="https-status">Active</span>
          </div>
          <div class="security-item">
            <span class="security-item-label">Honeypot Protection</span>
            <span class="security-badge active" id="honeypot-status">Active</span>
          </div>
          <div class="security-item">
            <span class="security-item-label">Cookie Consent</span>
            <span class="security-badge active" id="consent-status">Active</span>
          </div>
          <div class="security-item">
            <span class="security-item-label">Security Headers</span>
            <span class="security-badge active" id="headers-status">Active</span>
          </div>
          <div class="security-item">
            <span class="security-item-label">CSP Policy</span>
            <span class="security-badge active" id="csp-status">Active</span>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="activity-feed">
        <h3>üïê Recent Activity</h3>
        <div id="activity-list">
          <div class="activity-item">
            <div class="activity-item-time">Just now</div>
            <div class="activity-item-text">Admin dashboard accessed</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h3>‚ö° Quick Actions</h3>
        <div class="actions-grid">
          <a href="https://analytics.google.com" target="_blank" class="action-button">
            <span>üìä</span> Open Google Analytics
          </a>
          <a href="https://app.netlify.com" target="_blank" class="action-button">
            <span>üöÄ</span> Open Netlify Dashboard
          </a>
          <a href="https://github.com/PartyProtect/revive-your-hair-website-" target="_blank" class="action-button">
            <span>üíª</span> Open GitHub Repo
          </a>
          <a href="https://securityheaders.com/?q=www.reviveyourhair.eu" target="_blank" class="action-button secondary">
            <span>üîí</span> Test Security Headers
          </a>
          <a href="https://www.ssllabs.com/ssltest/analyze.html?d=www.reviveyourhair.eu" target="_blank" class="action-button secondary">
            <span>üîê</span> Test SSL/TLS
          </a>
          <button onclick="clearAnalytics()" class="action-button secondary">
            <span>üóëÔ∏è</span> Clear Analytics Cache
          </button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ============================================================================
    // ENHANCED PASSWORD PROTECTION (Level 2 Security)
    // ============================================================================

    // Password is stored as SHA-256 hash (not visible in source)
    // To generate new hash, run in console: hashPassword('YourPassword').then(h => console.log(h))
    const PASSWORD_HASH = '215e1a2171349b3875167351971b9ccf293a9fbac9fca7de802602e77d2d1ae4'; // Hash of: ReviveHair2025!
    const PASSWORD_KEY = 'admin_authenticated';
    
    // Rate limiting variables
    let loginAttempts = parseInt(localStorage.getItem('login_attempts') || '0');
    let lockoutTime = parseInt(localStorage.getItem('lockout_time') || '0');

    // Hash password using SHA-256
    async function hashPassword(password) {
      const msgBuffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Enhanced password check with rate limiting
    async function checkPassword() {
      const input = document.getElementById('admin-password');
      const error = document.getElementById('login-error');
      
      // Check if locked out
      if (lockoutTime && Date.now() < lockoutTime) {
        const remainingSeconds = Math.ceil((lockoutTime - Date.now()) / 1000);
        error.textContent = `üîí Too many failed attempts. Locked for ${remainingSeconds} seconds.`;
        error.classList.remove('hidden');
        
        // Update countdown every second
        setTimeout(checkPassword, 1000);
        return;
      } else if (lockoutTime && Date.now() >= lockoutTime) {
        // Reset lockout
        loginAttempts = 0;
        lockoutTime = 0;
        localStorage.removeItem('login_attempts');
        localStorage.removeItem('lockout_time');
      }
      
      // Hash input password
      const inputHash = await hashPassword(input.value);
      
      // Check against stored hash
      if (inputHash === PASSWORD_HASH) {
        // Success - reset attempts and grant access
        loginAttempts = 0;
        lockoutTime = 0;
        localStorage.removeItem('login_attempts');
        localStorage.removeItem('lockout_time');
        
        sessionStorage.setItem(PASSWORD_KEY, 'true');
        sessionStorage.setItem('login_time', Date.now().toString());
        
        // Log successful login
        console.log('[Security] Admin login successful:', new Date().toISOString());
        
        // Hide login, show dashboard
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('dashboard-content').classList.remove('hidden');
        
        // Initialize dashboard
        initDashboard();
        
        // Start inactivity timer
        resetInactivityTimer();
      } else {
        // Failed attempt
        loginAttempts++;
        localStorage.setItem('login_attempts', loginAttempts.toString());
        
        if (loginAttempts >= 3) {
          // Lock out for 5 minutes after 3 failed attempts
          lockoutTime = Date.now() + (5 * 60 * 1000);
          localStorage.setItem('lockout_time', lockoutTime.toString());
          
          error.textContent = 'üîí Too many failed attempts. Locked for 5 minutes.';
          
          // Log suspicious activity
          console.warn('[Security] Multiple failed login attempts:', {
            timestamp: new Date().toISOString(),
            attempts: loginAttempts,
            userAgent: navigator.userAgent,
            ip: 'client-side (no IP available)'
          });
        } else {
          const remaining = 3 - loginAttempts;
          error.textContent = `‚ùå Incorrect password. ${remaining} attempt${remaining !== 1 ? 's' : ''} remaining.`;
        }
        
        error.classList.remove('hidden');
        input.value = '';
        input.focus();
      }
    }

    // Allow Enter key to submit password
    document.getElementById('admin-password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkPassword();
      }
    });

    // ============================================================================
    // AUTO-LOGOUT & SESSION MANAGEMENT
    // ============================================================================

    let inactivityTimer;
    const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes
    const MAX_SESSION_TIME = 8 * 60 * 60 * 1000; // 8 hours

    // Reset inactivity timer on user activity
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      
      inactivityTimer = setTimeout(() => {
        console.log('[Security] Auto-logout: Inactivity timeout reached');
        sessionStorage.removeItem(PASSWORD_KEY);
        sessionStorage.removeItem('login_time');
        alert('‚è±Ô∏è Session expired due to inactivity. Please login again.');
        location.reload();
      }, INACTIVITY_TIMEOUT);
    }

    // Check session timeout
    function checkSessionTimeout() {
      const loginTime = sessionStorage.getItem('login_time');
      if (loginTime) {
        const elapsed = Date.now() - parseInt(loginTime);
        
        if (elapsed > MAX_SESSION_TIME) {
          console.log('[Security] Auto-logout: Maximum session time exceeded');
          sessionStorage.removeItem(PASSWORD_KEY);
          sessionStorage.removeItem('login_time');
          alert('‚è±Ô∏è Session expired (8 hours max). Please login again.');
          location.reload();
        }
      }
    }

    // Monitor user activity for inactivity logout
    if (sessionStorage.getItem(PASSWORD_KEY) === 'true') {
      document.addEventListener('mousemove', resetInactivityTimer);
      document.addEventListener('keypress', resetInactivityTimer);
      document.addEventListener('click', resetInactivityTimer);
      document.addEventListener('scroll', resetInactivityTimer);
      
      // Check session timeout every minute
      setInterval(checkSessionTimeout, 60000);
    }

    // Check if already authenticated
    window.addEventListener('DOMContentLoaded', function() {
      if (sessionStorage.getItem(PASSWORD_KEY) === 'true') {
        // Check if session is still valid
        checkSessionTimeout();
        
        if (sessionStorage.getItem(PASSWORD_KEY) === 'true') {
          document.getElementById('login-overlay').classList.add('hidden');
          document.getElementById('dashboard-content').classList.remove('hidden');
          initDashboard();
          resetInactivityTimer();
        }
      }
    });

    // ============================================================================
    // DASHBOARD FUNCTIONALITY
    // ============================================================================

    function initDashboard() {
      loadAnalyticsData();
      loadSecurityStatus();
      loadRecentActivity();
      
      // Refresh data every 30 seconds
      setInterval(loadAnalyticsData, 30000);
    }

    async function loadAnalyticsData() {
      try {
        // Fetch real data from custom tracking API
        const response = await fetch('/.netlify/functions/tracking?action=stats');
        
        if (!response.ok) {
          throw new Error('Failed to fetch analytics data');
        }

        const stats = await response.json();
        
        // Calculate totals
        const totalVisitors = stats.totalVisitors || 0;
        const todayStats = stats.today || {};
        const last7Days = stats.last7Days || [];
        
        // Calculate page views today
        const pageViewsToday = todayStats.pageViews || 0;
        
        // Calculate bots blocked
        const botsBlocked = todayStats.bots || 0;
        const totalTraffic = pageViewsToday + botsBlocked;
        const botPercentage = totalTraffic > 0 ? Math.round((botsBlocked / totalTraffic) * 100) : 0;
        
        // Calculate average session duration
        const recentSessions = stats.last7Days.flatMap(day => day.sessions || []);
        const avgDuration = recentSessions.length > 0
          ? recentSessions.reduce((sum, s) => sum + (s.duration || 0), 0) / recentSessions.length
          : 0;
        const avgMinutes = Math.floor(avgDuration / 60000);
        const avgSeconds = Math.floor((avgDuration % 60000) / 1000);
        
        // Calculate bounce rate
        const totalSessions = todayStats.sessions || 0;
        const totalBounces = todayStats.bounces || 0;
        const bounceRate = totalSessions > 0 ? Math.round((totalBounces / totalSessions) * 100) : 0;
        
        // Calculate changes (compare today vs yesterday)
        const yesterday = last7Days.length >= 2 ? last7Days[last7Days.length - 2] : null;
        const visitorsChange = yesterday && yesterday.uniqueVisitors > 0
          ? Math.round(((todayStats.uniqueVisitors - yesterday.uniqueVisitors) / yesterday.uniqueVisitors) * 100)
          : 0;
        const pageViewsChange = yesterday && yesterday.pageViews > 0
          ? Math.round(((pageViewsToday - yesterday.pageViews) / yesterday.pageViews) * 100)
          : 0;
        
        // Update UI with real data
        document.getElementById('total-visitors').textContent = totalVisitors.toLocaleString();
        document.getElementById('visitors-change').textContent = 
          visitorsChange >= 0 ? `+${visitorsChange}% from yesterday` : `${visitorsChange}% from yesterday`;
        
        document.getElementById('page-views').textContent = pageViewsToday.toLocaleString();
        document.getElementById('pageviews-change').textContent = 
          pageViewsChange >= 0 ? `+${pageViewsChange}% from yesterday` : `${pageViewsChange}% from yesterday`;
        
        document.getElementById('bots-blocked').textContent = botsBlocked.toLocaleString();
        document.getElementById('bots-percentage').textContent = `${botPercentage}% of total traffic`;
        
        document.getElementById('avg-session').textContent = `${avgMinutes}m ${avgSeconds}s`;
        document.getElementById('session-change').textContent = 'Real-time data';
        
        document.getElementById('bounce-rate').textContent = `${bounceRate}%`;
        document.getElementById('bounce-change').textContent = totalSessions > 0 ? `${totalSessions} sessions today` : 'No data';
        
        // Count form submissions from events
        const formSubmissions = (todayStats.events || []).filter(e => e.name === 'form_submit').length;
        document.getElementById('form-submissions').textContent = formSubmissions.toString();
        document.getElementById('forms-spam').textContent = `Bots blocked: ${botsBlocked}`;
        
        // Update charts placeholder text
        const visitorsChart = document.getElementById('visitors-chart');
        if (visitorsChart) {
          visitorsChart.innerHTML = `
            <p style="color: #6b7280;">üìä Visitor Trends (Last 7 Days)</p>
            <p style="margin-top: 10px; font-size: 14px;">
              ${last7Days.map(day => 
                `<span style="display: inline-block; margin: 5px;">${day.date}: ${day.uniqueVisitors || 0} visitors</span>`
              ).join('<br>')}
            </p>
          `;
        }
        
        console.log('[Dashboard] Analytics data loaded:', stats);
        
      } catch (error) {
        console.error('[Dashboard] Error loading analytics:', error);
        
        // Show error state
        document.getElementById('total-visitors').textContent = 'Error';
        document.getElementById('visitors-change').textContent = 'Failed to load data';
      }
    }

    function loadSecurityStatus() {
      // All security features are active (from our implementation)
      const statuses = {
        'bot-detection-status': 'Active',
        'https-status': 'Active',
        'honeypot-status': 'Active',
        'consent-status': 'Active',
        'headers-status': 'Active',
        'csp-status': 'Active'
      };

      Object.entries(statuses).forEach(([id, status]) => {
        document.getElementById(id).textContent = status;
      });
    }

    function loadRecentActivity() {
      const activityList = document.getElementById('activity-list');
      
      // Fetch recent activity from tracking API
      fetch('/.netlify/functions/tracking?action=stats')
        .then(res => res.json())
        .then(stats => {
          const recentEvents = stats.recentEvents || [];
          const recentPageViews = stats.recentPageViews || [];
          
          // Combine and sort by timestamp
          const activities = [
            ...recentEvents.slice(-5).map(e => ({
              time: getTimeAgo(e.timestamp),
              text: getEventText(e)
            })),
            ...recentPageViews.slice(-3).map(pv => ({
              time: getTimeAgo(pv.timestamp),
              text: `Page view: ${pv.page}`
            }))
          ].sort((a, b) => b.timestamp - a.timestamp).slice(0, 7);
          
          if (activities.length === 0) {
            activityList.innerHTML = '<p style="color: #6b7280; padding: 20px; text-align: center;">No activity yet. Start browsing your site!</p>';
            return;
          }

          activityList.innerHTML = activities.map(activity => `
            <div class="activity-item">
              <span class="activity-time">${activity.time}</span>
              <span class="activity-text">${activity.text}</span>
            </div>
          `).join('');
        })
        .catch(error => {
          console.error('[Dashboard] Error loading activity:', error);
          activityList.innerHTML = '<p style="color: #ef4444; padding: 20px;">Failed to load activity</p>';
        });
    }
    
    function getTimeAgo(timestamp) {
      const diff = Date.now() - new Date(timestamp).getTime();
      const minutes = Math.floor(diff / 60000);
      
      if (minutes < 1) return 'Just now';
      if (minutes === 1) return '1 minute ago';
      if (minutes < 60) return `${minutes} minutes ago`;
      
      const hours = Math.floor(minutes / 60);
      if (hours === 1) return '1 hour ago';
      if (hours < 24) return `${hours} hours ago`;
      
      const days = Math.floor(hours / 24);
      return days === 1 ? '1 day ago' : `${days} days ago`;
    }
    
    function getEventText(event) {
      switch (event.eventName) {
        case 'form_submit':
          return `Form submitted: ${event.eventData?.formId || 'unknown'}`;
        case 'cta_click':
          return `CTA clicked: ${event.eventData?.text?.substring(0, 30) || 'button'}`;
        case 'external_link_click':
          return `External link clicked`;
        default:
          return `Event: ${event.eventName}`;
      }
    }

    function clearAnalytics() {
      if (confirm('Clear all cached analytics data? This will not affect actual Google Analytics data.')) {
        // Clear localStorage analytics cache
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('_ga') || key.includes('analytics')) {
            localStorage.removeItem(key);
          }
        });
        
        alert('‚úÖ Analytics cache cleared successfully!');
        location.reload();
      }
    }

    // Track dashboard usage (meta!)
    if (typeof gtag !== 'undefined') {
      gtag('event', 'page_view', {
        page_title: 'Admin Dashboard',
        page_location: '/admin/dashboard',
      });
    }
  </script>

</body>
</html>
